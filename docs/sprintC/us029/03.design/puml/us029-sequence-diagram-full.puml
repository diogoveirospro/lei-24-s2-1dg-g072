@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

actor "Collaborator" as Col
participant ":RecordCompletionUI" as UI
participant ":FinishTaskController" as CTRL
participant ":ApplicationSession" as _APP
participant "appSession\n:ApplicationSession" as APP
participant "currentSession\n:UserSession" as SESSION
participant ":Repositories" as RepositorySingleton
participant "repositories\n:Repositories" as REP
participant "collaboratorRepository\n:CollaboratorRepository" as collaboratorRepository
participant "teamRepository\n:TeamRepository" as teamRepository
participant "agenda\n:Agenda" as AGENDA
participant "agendaEntry\n:AgendaEntry" as AGENDAENTRY
participant "agendaEntries\n:List<AgendaEntry>" as AGENDAENTRIES
participant ":AgendaEntryMapper" as Mapper
participant "listAgendaEntriesDto\n:List<AgendaEntryDto>" as ListAgendaEntriesDto
participant "agendaEntryDto\n:AgendaEntryDto" as DTO

activate Col

Col -> UI : requests to consult tasks assigned to him
    activate UI

    UI -> CTRL** : create
    UI -> CTRL : getCollaboratorByEmail(email)
        activate CTRL

            CTRL -> CTRL : getCollaboratorFromSession(email)
            activate CTRL
           CTRL -> _APP**: getInstance()
           activate _APP

                _APP -> CTRL: appSession
           deactivate _APP

           CTRL -> APP**: getCurrentSession()
           activate APP

                APP --> CTRL: currentSession
           deactivate APP

           CTRL -> SESSION**: getUserEmail()
           activate SESSION

                SESSION --> CTRL: email
           deactivate SESSION

        CTRL -> RepositorySingleton : getInstance()
            activate RepositorySingleton

            RepositorySingleton --> CTRL : repositories
            deactivate RepositorySingleton

        CTRL -> REP : getCollaboratorRepository
            activate REP

            REP --> CTRL : collaboratorRepository
            deactivate REP

        CTRL -> collaboratorRepository : getCollaboratorByEmail(email)
            activate collaboratorRepository

            collaboratorRepository -> collaboratorRepository : getCollaboratorByEmail(email)
            activate collaboratorRepository

            collaboratorRepository --> CTRL : collaborator

                deactivate collaboratorRepository

            deactivate collaboratorRepository
        CTRL --> UI : collaborator
        deactivate CTRL

        deactivate CTRL

UI -> Col : Asks to select the beginning and end date of the search
deactivate UI

Col -> UI : Selects the beginning and end date
activate UI

UI -> CTRL : getTaskList(collaborator, dateI, dateF, typeStatus)
activate CTRL

    CTRL -> RepositorySingleton : getInstance()
    activate RepositorySingleton

        RepositorySingleton --> CTRL : repositories
    deactivate RepositorySingleton

    CTRL -> REP : getAgenda()
    activate REP

        REP --> CTRL : agenda
    deactivate REP

    CTRL -> REP : getTeamRepository()
    activate REP

        REP --> CTRL : teamRepository
    deactivate REP

    CTRL -> teamRepository : getTeamsByCollaborator(collaborator)
    activate teamRepository

        teamRepository -> teamRepository : getTeamsByCollaborator(collaborator)
        activate teamRepository

        teamRepository --> CTRL : teamList
        deactivate teamRepository
        deactivate teamRepository

    CTRL -> AGENDA : getAgendaEntriesByTeamList(teamList)
    activate AGENDA

        AGENDA --> AGENDAENTRIES** : create()
        loop for each agendaEntry in the specified date range and status
            AGENDA -> AGENDAENTRIES : add(agendaEntry)
            activate AGENDAENTRIES
        end
        AGENDAENTRIES --> AGENDA : agendaEntryList
        deactivate AGENDAENTRIES
    AGENDA --> CTRL : agendaEntryList
    deactivate AGENDA

    CTRL -> Mapper : toDTOList(agendaEntryList)
    activate Mapper

        Mapper --> ListAgendaEntriesDto** : create()
        loop for each agendaEntry in agendaEntryList
            Mapper -> DTO : get(i)
            activate DTO

            DTO --> Mapper : agendaEntry
            deactivate DTO

            Mapper -> DTO : toDTOEntry(agendaEntry)
            activate DTO

            DTO --> Mapper : agendaEntryDto
            deactivate DTO

            Mapper -> ListAgendaEntriesDto : add(agendaEntryDto)
            activate ListAgendaEntriesDto
        end
        ListAgendaEntriesDto --> Mapper : agendaEntryListDto
        deactivate ListAgendaEntriesDto

    Mapper --> CTRL : agendaEntryListDto
    deactivate Mapper

CTRL --> UI : agendaEntryListDto
deactivate CTRL

UI --> Col : Displays the list of tasks
deactivate UI

Col -> UI : Selects the task to mark as completed
activate UI

UI -> CTRL : finishTask(taskId)
activate CTRL

    CTRL -> RepositorySingleton : getInstance()
    activate RepositorySingleton

        RepositorySingleton --> CTRL : repositories
    deactivate RepositorySingleton

    CTRL -> REP : getAgenda()
    activate REP

        REP --> CTRL : agenda
    deactivate REP

    CTRL -> AGENDA : getAgendaEntry(taskId)
    activate AGENDA

        AGENDA --> CTRL : agendaEntry
    deactivate AGENDA

    CTRL -> AGENDAENTRY : taskDone()
    activate AGENDAENTRY

        AGENDAENTRY --> CTRL : operation success
    deactivate AGENDAENTRY

            CTRL -> Mapper : toDTOList(agendaEntryList)
                activate Mapper

                Mapper --> ListAgendaEntriesDto** : create()
                    loop for each agendaEntry in agendaEntryList
                        Mapper -> DTO : get(i)
                            activate DTO

                            DTO --> Mapper : agendaEntry
                            deactivate DTO
                        Mapper -> DTO : toDTOEntry(agendaEntry)
                            activate DTO

                            DTO --> Mapper : agendaEntryDto
                            deactivate DTO
                        Mapper -> ListAgendaEntriesDto : add(agendaEntryDto)
                            activate ListAgendaEntriesDto
                    end


                ListAgendaEntriesDto --> Mapper : agendaEntryListDto
                 deactivate ListAgendaEntriesDto

                 Mapper --> CTRL : agendaEntryListDto
                deactivate Mapper


CTRL --> UI : agendaEntryDto
deactivate CTRL

UI --> Col : Shows task completion confirmation
deactivate UI

deactivate Col

@enduml
